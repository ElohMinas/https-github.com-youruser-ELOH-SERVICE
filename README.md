
/* Eloh Service — Protótipo Navegável (React) — Versão com Style Guide + Assets
   (This file was generated by the assistant for the prototype.)
*/
import React, { useEffect, useState, useRef } from 'react';

// ---------- Theme tokens (matches style guide) ----------
const colors = {
  primary: '#1E3A8A', // Azul Eloh
  primaryLight: '#3B82F6',
  bg: '#F3F4F6',
  white: '#FFFFFF',
  text: '#1F2937',
  textMuted: '#6B7280',
  success: '#16A34A',
  warn: '#FACC15',
  danger: '#DC2626'
};

// ---------- Local storage helpers ----------
const uid = () => Math.random().toString(36).slice(2, 9);
const STORAGE_KEY = 'eloh_os_data_v1';
const defaultData = {
  users: [
    { id: 'u_admin', name: 'Admin Eloh', role: 'admin' },
    { id: 'u_tech1', name: 'Carlos (Técnico)', role: 'tech' },
    { id: 'u_tech2', name: 'Mariana (Técnica)', role: 'tech' }
  ],
  os: [
    { id: 'os1', number: 'OS-2025-001', client: 'Empresa Alfa', address: 'Av. Paulista, 1000', description: 'Manutenção preventiva do gerador', priority: 'Alta', status: 'Aberta', assignedTo: 'u_tech1', createdAt: Date.now(), offlineActions: [] }
  ]
};
function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
    return defaultData;
  }
  try { return JSON.parse(raw); } catch (e) { localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData)); return defaultData; }
}
function saveData(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

// ---------- SignaturePad Component ----------
function SignaturePad({ onSave }) {
  const canvasRef = useRef(null);
  const drawing = useRef(false);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const resize = () => {
      const ratio = window.devicePixelRatio || 1;
      const w = canvas.clientWidth * ratio;
      const h = canvas.clientHeight * ratio;
      canvas.width = w; canvas.height = h;
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
    };
    resize();
    window.addEventListener('resize', resize);

    const start = (e) => { drawing.current = true; ctx.beginPath(); const rect = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top; ctx.moveTo(x, y); };
    const move = (e) => { if (!drawing.current) return; const rect = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top; ctx.lineTo(x, y); ctx.stroke(); };
    const end = () => { drawing.current = false; };

    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', move); window.addEventListener('touchend', end);

    return () => {
      window.removeEventListener('resize', resize);
      canvas.removeEventListener('mousedown', start); canvas.removeEventListener('mousemove', move); window.removeEventListener('mouseup', end);
      canvas.removeEventListener('touchstart', start); canvas.removeEventListener('touchmove', move); window.removeEventListener('touchend', end);
    };
  }, []);

  const clear = () => { const canvas = canvasRef.current; const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); };
  const save = () => { onSave(canvasRef.current.toDataURL('image/png')); };

  return (
    <div className="p-2 border rounded-md bg-white">
      <canvas ref={canvasRef} style={{ width: '100%', height: 150 }} className="border rounded-md touch-manipulation" />
      <div className="flex gap-2 mt-2">
        <button className="px-3 py-1 rounded bg-gray-200" onClick={clear}>Limpar</button>
        <button className="px-3 py-1 rounded" style={{ background: colors.primary, color: '#fff' }} onClick={save}>Salvar assinatura</button>
      </div>
    </div>
  );
}

// ---------- PhotoUploader ----------
function PhotoUploader({ photos, onChange }) {
  const handleFiles = (e) => {
    const files = Array.from(e.target.files).slice(0, 5);
    const readers = files.map(f => new Promise((res) => {
      const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(f);
    }));
    Promise.all(readers).then(results => onChange([...(photos||[]), ...results]));
  };
  return (
    <div>
      <input type="file" accept="image/*" multiple onChange={handleFiles} />
      <div className="mt-2 grid grid-cols-3 gap-2">
        {(photos||[]).map((p, i) => (<img key={i} src={p} alt={`photo-${i}`} className="w-full h-24 object-cover rounded" />))}
      </div>
    </div>
  );
}

// ---------- Main App ----------
export default function App() {
  const [data, setData] = useState(loadData());
  const [user, setUser] = useState(null);
  const [screen, setScreen] = useState('login'); // login, list, details, admin, execute
  const [selectedOS, setSelectedOS] = useState(null);
  const [isOffline, setIsOffline] = useState(false);

  useEffect(() => saveData(data), [data]);

  const handleLogin = (userId) => { const u = data.users.find(x => x.id === userId); setUser(u); setScreen(u.role === 'admin' ? 'admin' : 'list'); };

  const createOS = (payload) => {
    const newOS = { id: uid(), number: `OS-${Date.now()}`, createdAt: Date.now(), status: 'Aberta', offlineActions: [], ...payload };
    const nd = { ...data, os: [newOS, ...data.os] };
    setData(nd); alert('OS criada com sucesso');
  };

  const saveExecution = (osId, execData) => {
    const osIndex = data.os.findIndex(o => o.id === osId);
    if (osIndex === -1) return;
    const os = { ...data.os[osIndex] };
    const action = { id: uid(), type: 'execution', data: execData, date: Date.now() };
    os.offlineActions = [...(os.offlineActions||[]), action];
    if (execData.complete) os.status = 'Finalizada';
    const newOsArr = [...data.os]; newOsArr[osIndex] = os; const nd = { ...data, os: newOsArr };
    setData(nd); alert('Execução salva localmente. Quando online, pressione Sincronizar.');
  };

  const syncAll = () => { const newOs = data.os.map(o => ({ ...o, offlineActions: [] })); const nd = { ...data, os: newOs }; setData(nd); alert('Sincronizado com sucesso (simulado).'); };

  const openOS = (os) => { setSelectedOS(os); setScreen('details'); };
  const visibleOS = user?.role === 'admin' ? data.os : data.os.filter(o => o.assignedTo === user?.id);

  return (
    <div style={{ background: colors.bg }} className="min-h-screen p-4 font-sans">
      <div className="max-w-md mx-auto">
        <header className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <img src="/assets/logo.png" alt="Eloh Service" style={{ height: 40 }} />
            <div>
              <div style={{ color: colors.primary, fontWeight: 600 }} className="text-lg">Eloh Service</div>
              <div className="text-xs text-gray-500">Protótipo corporativo — iOS</div>
            </div>
          </div>
          <div className="text-right">
            <div className="text-sm text-gray-600">{user ? user.name : 'Aguardando login'}</div>
            <div className="text-xs text-gray-500">{user ? (user.role==='admin'? 'Administrador':'Técnico') : ''}</div>
          </div>
        </header>

        <div className="mb-3 flex gap-2">
          <button className={`px-3 py-1 rounded`} style={{ background: isOffline ? colors.warn : '#E5E7EB' }} onClick={() => setIsOffline(s => !s)}>{isOffline? 'Offline (simulado)':'Online'}</button>
          <button className="px-3 py-1 rounded" style={{ background: colors.primary, color: '#fff' }} onClick={syncAll}>Sincronizar</button>
          {user && <button className="px-3 py-1 rounded bg-gray-200" onClick={() => { setUser(null); setScreen('login'); }}>Logout</button>}
        </div>

        {screen === 'login' && (
          <div className="bg-white p-4 rounded shadow">
            <h2 className="font-medium mb-2">Login por função</h2>
            <p className="text-sm text-gray-600 mb-3">Selecione um usuário para simular o login.</p>
            <div className="grid gap-2">
              {data.users.map(u => (
                <button key={u.id} className="p-3 border rounded text-left" onClick={() => handleLogin(u.id)}>
                  <div className="font-semibold">{u.name}</div>
                  <div className="text-xs text-gray-500">{u.role === 'admin' ? 'Administrador' : 'Técnico'}</div>
                </button>
              ))}
            </div>
          </div>
        )}

        {screen === 'admin' && user && (
          <div className="bg-white p-4 rounded shadow">
            <h2 className="font-medium mb-2">Painel Admin</h2>
            <CreateOSForm users={data.users} onCreate={createOS} />
            <AdminReports osList={data.os} users={data.users} />
            <div className="mt-4">
              <h3 className="font-semibold mb-2">Ordens de Serviço</h3>
              <OSList osList={data.os} onOpen={openOS} users={data.users} />
            </div>
          </div>
        )}

        {screen === 'list' && user && (
          <div className="bg-white p-4 rounded shadow">
            <h2 className="font-medium mb-2">Minhas Ordens</h2>
            <OSList osList={visibleOS} onOpen={openOS} users={data.users} />
          </div>
        )}

        {screen === 'details' && selectedOS && (
          <div className="bg-white p-4 rounded shadow">
            <button className="text-sm text-blue-600 mb-2" onClick={() => setScreen(user.role === 'admin' ? 'admin' : 'list')}>⬅ Voltar</button>
            <OSDetails os={data.os.find(o=>o.id===selectedOS.id) || selectedOS} users={data.users} onExecute={(osId) => { setSelectedOS(data.os.find(o=>o.id===osId)); setScreen('execute'); }} />
          </div>
        )}

        {screen === 'execute' && selectedOS && (
          <div className="bg-white p-4 rounded shadow">
            <button className="text-sm text-blue-600 mb-2" onClick={() => setScreen('details')}>⬅ Voltar</button>
            <ExecuteOS os={data.os.find(o=>o.id===selectedOS.id) || selectedOS} onSave={(execData) => { saveExecution(selectedOS.id, execData); setScreen('list'); }} />
          </div>
        )}

        <footer className="mt-4 text-center text-xs text-gray-500">Protótipo Eloh Service — design corporativo (iOS)</footer>
      </div>
    </div>
  );
}

// ---------- Subcomponents ----------
function CreateOSForm({ users, onCreate }) {
  const [client, setClient] = useState('');
  const [address, setAddress] = useState('');
  const [desc, setDesc] = useState('');
  const [priority, setPriority] = useState('Normal');
  const [assignedTo, setAssignedTo] = useState(users.find(u=>u.role==='tech')?.id || '');
  const submit = (e) => { e.preventDefault(); if (!client || !desc) return alert('Preencha cliente e descrição'); onCreate({ client, address, description: desc, priority, assignedTo }); setClient(''); setAddress(''); setDesc(''); };
  return (
    <form onSubmit={submit} className="space-y-2">
      <input className="w-full p-2 border rounded" placeholder="Nome do cliente" value={client} onChange={e=>setClient(e.target.value)} />
      <input className="w-full p-2 border rounded" placeholder="Endereço" value={address} onChange={e=>setAddress(e.target.value)} />
      <textarea className="w-full p-2 border rounded" placeholder="Descrição" value={desc} onChange={e=>setDesc(e.target.value)} />
      <div className="flex gap-2">
        <select className="p-2 border rounded" value={priority} onChange={e=>setPriority(e.target.value)}>
          <option>Baixa</option>
          <option>Normal</option>
          <option>Alta</option>
        </select>
        <select className="p-2 border rounded" value={assignedTo} onChange={e=>setAssignedTo(e.target.value)}>
          {users.filter(u=>u.role==='tech').map(t=> <option key={t.id} value={t.id}>{t.name}</option>)}
        </select>
      </div>
      <div className="flex justify-end">
        <button className="px-4 py-2" style={{ background: colors.primary, color: '#fff', borderRadius: 8 }}>Criar OS</button>
      </div>
    </form>
  );
}

function OSList({ osList, onOpen, users }) {
  const getTech = (id) => users.find(u=>u.id===id)?.name || '-';
  if (!osList || osList.length===0) return <div className="text-sm text-gray-500">Nenhuma OS.</div>;
  return (
    <div className="space-y-2">
      {osList.map(o => (
        <div key={o.id} className="p-3 border rounded flex justify-between items-center">
          <div>
            <div className="font-semibold">{o.number} — {o.client}</div>
            <div className="text-xs text-gray-500">{o.description}</div>
            <div className="text-xs text-gray-500">Técnico: {getTech(o.assignedTo)}</div>
          </div>
          <div className="text-right">
            <div className="text-sm font-medium">{o.status}</div>
            <button className="mt-2 px-3 py-1" style={{ background: colors.primary, color: '#fff', borderRadius: 6 }} onClick={()=>onOpen(o)}>Abrir</button>
          </div>
        </div>
      ))}
    </div>
  );
}

function OSDetails({ os, users, onExecute }) {
  const tech = users.find(u=>u.id===os.assignedTo)?.name || '-';
  return (
    <div>
      <h2 className="font-semibold mb-1">{os.number}</h2>
      <div className="text-sm text-gray-600 mb-2">Cliente: {os.client}</div>
      <div className="text-sm text-gray-600 mb-2">Endereço: {os.address}</div>
      <div className="mb-2">{os.description}</div>
      <div className="mb-2 text-xs text-gray-500">Prioridade: {os.priority} • Técnico: {tech}</div>
      <div className="flex gap-2">
        <button className="px-3 py-2" style={{ background: colors.primary, color: '#fff', borderRadius: 8 }} onClick={() => onExecute(os.id)}>Executar OS</button>
      </div>
    </div>
  );
}

function ExecuteOS({ os, onSave }) {
  const [photos, setPhotos] = useState([]);
  const [notes, setNotes] = useState('');
  const [signature, setSignature] = useState(null);
  const [complete, setComplete] = useState(false);

  const handleSave = () => { if (!signature) return alert('Assinatura é necessária para finalizar'); const execData = { photos, notes, signature, complete }; onSave(execData); };

  return (
    <div>
      <h3 className="font-semibold mb-2">Execução — {os.number}</h3>
      <div className="mb-2">
        <label className="block text-sm font-medium">Fotos</label>
        <PhotoUploader photos={photos} onChange={setPhotos} />
      </div>
      <div className="mb-2">
        <label className="block text-sm font-medium">Anotações</label>
        <textarea className="w-full p-2 border rounded" rows={3} value={notes} onChange={e=>setNotes(e.target.value)} />
      </div>
      <div className="mb-2">
        <label className="block text-sm font-medium">Assinatura do cliente</label>
        <SignaturePad onSave={(d)=> setSignature(d)} />
        {signature && <div className="mt-2"><img src={signature} alt="assinatura" className="w-48 h-20 object-contain border rounded" /></div>}
      </div>
      <div className="flex items-center gap-2 mb-2">
        <input id="complete" type="checkbox" checked={complete} onChange={e=>setComplete(e.target.checked)} />
        <label htmlFor="complete" className="text-sm text-gray-700">Marcar como concluída</label>
      </div>
      <div className="flex justify-end">
        <button className="px-4 py-2" style={{ background: colors.primary, color: '#fff', borderRadius: 8 }} onClick={handleSave}>Salvar execução</button>
      </div>
    </div>
  );
}


// ---------- Admin Reports & Filters ----------
function AdminReports({ osList, users }) {
  const [statusFilter, setStatusFilter] = useState('Todos');
  const [techFilter, setTechFilter] = useState('Todos');
  const [priorityFilter, setPriorityFilter] = useState('Todos');

  const statuses = ['Todos','Aberta','Em andamento','Finalizada'];
  const priorities = ['Todos','Baixa','Normal','Alta'];

  const filtered = osList.filter(o => {
    if (statusFilter !== 'Todos' && o.status !== statusFilter) return false;
    if (techFilter !== 'Todos' && o.assignedTo !== techFilter) return false;
    if (priorityFilter !== 'Todos' && o.priority !== priorityFilter) return false;
    return true;
  });

  const summary = {
    total: osList.length,
    aberta: osList.filter(o=>o.status==='Aberta').length,
    andamento: osList.filter(o=>o.status==='Em andamento').length,
    finalizada: osList.filter(o=>o.status==='Finalizada').length
  };

  const exportCSV = () => {
    const rows = [['Número','Cliente','Técnico','Prioridade','Status','Criada em']];
    filtered.forEach(o => {
      const tech = users.find(u=>u.id===o.assignedTo)?.name || '-';
      rows.push([o.number, o.client, tech, o.priority, o.status, new Date(o.createdAt).toLocaleString()]);
    });
    const csv = rows.map(r => r.map(cell => '\"' + String(cell).replace(/\"/g,'\"\"') + '\"').join(',')).join('\\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'eloh_report.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div className="mt-4 p-3 border rounded bg-white">
      <h4 className="font-semibold mb-2">Relatórios</h4>
      <div className="flex gap-2 mb-3">
        <select value={statusFilter} onChange={e=>setStatusFilter(e.target.value)} className="p-2 border rounded">
          {statuses.map(s=> <option key={s}>{s}</option>)}
        </select>
        <select value={techFilter} onChange={e=>setTechFilter(e.target.value)} className="p-2 border rounded">
          <option>Todos</option>
          {users.filter(u=>u.role==='tech').map(t=> <option key={t.id} value={t.id}>{t.name}</option>)}
        </select>
        <select value={priorityFilter} onChange={e=>setPriorityFilter(e.target.value)} className="p-2 border rounded">
          {priorities.map(p=> <option key={p}>{p}</option>)}
        </select>
        <button className="px-3 py-1" style={{ background: '#1E3A8A', color:'#fff', borderRadius:6 }} onClick={exportCSV}>Exportar CSV</button>
      </div>

      <div className="text-sm text-gray-700 mb-2">Resumo: Total {summary.total} • Aberta {summary.aberta} • Em andamento {summary.andamento} • Finalizada {summary.finalizada}</div>

      <div className="space-y-2">
        {filtered.map(o => (
          <div key={o.id} className="p-2 border rounded flex justify-between items-center">
            <div>
              <div className="font-semibold">{o.number} — {o.client}</div>
              <div className="text-xs text-gray-500">{o.description}</div>
            </div>
            <div className="text-right text-xs text-gray-500">{o.priority} • {o.status}</div>
          </div>
        ))}
      </div>
    </div>
  );
}
